apiVersion: v1
kind: ConfigMap
metadata:
  name: eisenbahn-config
  namespace: eisenbahn
  labels:
    app.kubernetes.io/part-of: stupid-db
data:
  # ── Embedded eisenbahn.toml ────────────────────────────────────────
  eisenbahn.toml: |
    [broker]
    frontend = "tcp://eisenbahn-broker.eisenbahn.svc.cluster.local:5555"
    backend  = "tcp://eisenbahn-broker.eisenbahn.svc.cluster.local:5556"

    [transport]
    kind         = "tcp"
    default_host = "0.0.0.0"
    base_port    = 5560

    [workers.ingest]
    binary        = "stupid-ingest"
    subscriptions = ["raw.parquet", "raw.csv"]
    pipelines     = ["ingest"]
    instances     = 2

    [workers.ingest.env]
    RUST_LOG = "info"

    [workers.compute]
    binary        = "stupid-compute"
    subscriptions = ["entity.created", "entity.updated"]
    pipelines     = ["compute"]
    instances     = 1

    [workers.graph]
    binary        = "stupid-graph"
    subscriptions = ["edge.derived"]
    pipelines     = ["graph"]
    instances     = 1

    [pipeline.stages.ingest]
    concurrency = 4

    [pipeline.stages.compute]
    after       = ["ingest"]
    concurrency = 2

    [pipeline.stages.graph]
    after       = ["compute"]
    concurrency = 1

  # ── Environment variable overrides ─────────────────────────────────
  RUST_LOG: "info"
  EISENBAHN_TRANSPORT: "tcp"
  EISENBAHN_CONFIG: "/etc/eisenbahn/eisenbahn.toml"
  EISENBAHN_BROKER_HOST: "eisenbahn-broker.eisenbahn.svc.cluster.local"
  EISENBAHN_FRONTEND_PORT: "5555"
  EISENBAHN_BACKEND_PORT: "5556"
