# ── compose.yml ────────────────────────────────────────────────────
# Full stupid-db stack: monolith server, eisenbahn distributed workers,
# dashboard, and agent.
#
# Usage:
#   docker compose up -d                       # start all
#   docker compose up broker compute graph     # start subset
#   docker compose --profile eisenbahn up -d   # start eisenbahn workers only
#   docker compose logs -f compute             # tail logs

# ── Shared defaults for eisenbahn workers ──────────────────────────
x-worker-defaults: &worker-defaults
  build:
    context: .
    dockerfile: docker/Dockerfile.worker
  restart: unless-stopped
  networks:
    - default
  environment: &worker-env
    RUST_LOG: info
    EISENBAHN_TRANSPORT: tcp
    EISENBAHN_CONFIG: /app/config/eisenbahn.toml
    EISENBAHN_BROKER_HOST: broker
    EISENBAHN_FRONTEND_PORT: "5555"
    EISENBAHN_BACKEND_PORT: "5556"
  depends_on:
    broker:
      condition: service_healthy

services:
  # ════════════════════════════════════════════════════════════════════
  # Monolith server (existing)
  # ════════════════════════════════════════════════════════════════════
  stupid-db-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stupid-db-server
    ports:
      - "39100:39100"
    env_file:
      - .env
    environment:
      - PORT=39100
      - HOST=0.0.0.0
      - DATA_DIR=/data
      - RUST_LOG=info
    volumes:
      - stupid-db-data:/data
      # Bind-mount rules directory so host edits are live-reloaded
      - ./data/rules:/data/rules
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:39100/health"]
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 3

  stupid-claude-agent:
    build:
      context: ./packages/stupid-claude-agent
      dockerfile: Dockerfile
    container_name: stupid-claude-agent
    ports:
      - "39048:39048"  # FastAPI REST API
      - "39049:39049"  # MCP SSE server
    env_file:
      - .env
    environment:
      - HOST=0.0.0.0
      - PORT=39048
      - MCP_PORT=39049
    volumes:
      - ./packages/stupid-claude-agent/.claude:/app/.claude:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:39048/api/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  # ════════════════════════════════════════════════════════════════════
  # Eisenbahn distributed workers
  # ════════════════════════════════════════════════════════════════════

  # ── Broker ────────────────────────────────────────────────────────
  broker:
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: eisenbahn-broker
    container_name: eisenbahn-broker
    restart: unless-stopped
    ports:
      - "5555:5555"   # frontend (publishers connect)
      - "5556:5556"   # backend (subscribers connect)
      - "5557:5557"   # health check
      - "9090:9090"   # metrics
    environment:
      RUST_LOG: info
      EISENBAHN_TRANSPORT: tcp
      EISENBAHN_HOST: "0.0.0.0"
      EISENBAHN_FRONTEND_PORT: "5555"
      EISENBAHN_BACKEND_PORT: "5556"
      EISENBAHN_HEALTH_PORT: "5557"
      EISENBAHN_METRICS_PORT: "9090"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9090/health"]
      interval: 15s
      timeout: 5s
      start_period: 10s
      retries: 3

  # ── Compute Worker ────────────────────────────────────────────────
  compute:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: compute-worker
    container_name: eisenbahn-compute
    environment:
      <<: *worker-env
      COMPUTE_HEALTH_INTERVAL: "30"

  # ── Ingest Worker ─────────────────────────────────────────────────
  ingest:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: ingest-worker
    container_name: eisenbahn-ingest
    volumes:
      - ingest-data:/data
    environment:
      <<: *worker-env
      INGEST_DATA_DIR: /data

  # ── Graph Worker ──────────────────────────────────────────────────
  graph:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: graph-worker
    container_name: eisenbahn-graph

  # ── Storage Worker ────────────────────────────────────────────────
  storage:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: storage-worker
    container_name: eisenbahn-storage
    volumes:
      - storage-data:/data
    environment:
      <<: *worker-env
      STORAGE_DATA_DIR: /data

  # ── Rules Worker ──────────────────────────────────────────────────
  rules:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: rules-worker
    container_name: eisenbahn-rules

  # ── LLM Worker ───────────────────────────────────────────────────
  llm:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: llm-worker
    container_name: eisenbahn-llm
    environment:
      <<: *worker-env
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}

  # ── Notify Worker ─────────────────────────────────────────────────
  notify:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: notify-worker
    container_name: eisenbahn-notify

  # ── Agent Worker ──────────────────────────────────────────────────
  agent:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: agent-worker
    container_name: eisenbahn-agent

  # ── Segment Worker ───────────────────────────────────────────────
  segment:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: segment-worker
    container_name: eisenbahn-segment
    volumes:
      - segment-data:/data
    environment:
      <<: *worker-env
      SEGMENT_DATA_DIR: /data

  # ── Catalog Worker ───────────────────────────────────────────────
  catalog:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: catalog-worker
    container_name: eisenbahn-catalog

  # ── Athena Worker ────────────────────────────────────────────────
  athena:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: athena-worker
    container_name: eisenbahn-athena
    environment:
      <<: *worker-env
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}

  # ── Connector Worker ─────────────────────────────────────────────
  connector:
    <<: *worker-defaults
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        BINARY_NAME: connector-worker
    container_name: eisenbahn-connector

  # ════════════════════════════════════════════════════════════════════
  # Dashboard
  # ════════════════════════════════════════════════════════════════════
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: stupid-db-dashboard
    ports:
      - "39300:39300"
    environment:
      - NEXT_PUBLIC_API_URL=http://stupid-db-server:39100
    depends_on:
      stupid-db-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:39300').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  # ════════════════════════════════════════════════════════════════════
  # Stille Post Worker (AI agent runtime for report pipelines)
  # ════════════════════════════════════════════════════════════════════
  stille-post-worker:
    build:
      context: ./services/stille-post-worker
      dockerfile: Dockerfile
    container_name: stille-post-worker
    restart: unless-stopped
    ports:
      - "${SP_WORKER_PORT:-4100}:4100"
    env_file:
      - .env
    environment:
      DATABASE_URL: postgres://${PG_USERNAME:-postgres}:${PG_PASSWORD:-}@${PG_HOST:-localhost}:${PG_PORT:-5432}/${PG_DATABASE:-stupiddb}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      API_BASE: http://stupid-db-server:39100
      PORT: "4100"
    volumes:
      - sp-uploads:/app/uploads
    depends_on:
      stupid-db-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

volumes:
  stupid-db-data:
  ingest-data:
  storage-data:
  segment-data:
  sp-uploads:
