# ============================================================
# VIP Absence Detection
# ============================================================
# Flags VIP members (group >= 4) who have zero logins in the
# past 7 days. Useful for proactive retention outreach.
# Runs daily at 9 AM Manila time.
#
# To activate: set `enabled: true` and configure email/Telegram
# environment variables.

apiVersion: v1
kind: AnomalyRule

# ── Identity & lifecycle ─────────────────────────────────────
metadata:
  id: vip-absence
  name: VIP Absence Alert
  description: >
    Detect VIP members (vip_group_numeric >= 4) with zero logins
    over the last 7 days, indicating possible churn risk.
  tags: [vip, retention, absence]
  enabled: true

# ── When to run ──────────────────────────────────────────────
schedule:
  cron: "0 9 * * *"                 # daily at 09:00
  timezone: Asia/Manila

# ── What to detect ───────────────────────────────────────────
detection:
  template: absence
  params:
    feature: login_count
    threshold: 0                    # zero logins = absent
    lookback_days: 7                # 7-day inactivity window

# ── Who to evaluate ──────────────────────────────────────────
filters:
  entity_types: [Member]
  where:                            # filter on entity features
    vip_group_numeric:
      gte: 4                        # only VIP groups 4+

# ── Where to send alerts ─────────────────────────────────────
notifications:
  # Email notification for the retention team
  - channel: email
    on: [trigger]
    smtp_host: "${SMTP_HOST}"
    smtp_port: 587
    tls: true
    from: "${SMTP_FROM}"
    to:
      - "${ALERT_EMAIL}"
    subject: "[VIP Alert] Inactive VIP member detected"
    template: |
      Member {{ entity_key }} (VIP group {{ vip_group }}) has not
      logged in for 7+ days. Last seen: {{ last_seen }}.

  # Telegram notification for ops channel
  - channel: telegram
    on: [trigger, resolve]
    bot_token: "${TELEGRAM_BOT_TOKEN}"
    chat_id: "${TELEGRAM_CHAT_ID}"
    parse_mode: MarkdownV2
