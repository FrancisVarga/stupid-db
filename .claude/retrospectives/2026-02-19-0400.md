# Retrospective: 2026-02-19 04:00 UTC

## Session Focus
Two debugging sessions in the Bundeswehr dashboard agent system:
1. **Agent resolution error**: "agent not found: playground-assistant" (Rust serde enum case-sensitivity)
2. **TypeScript runtime error**: "Cannot read properties of undefined (reading 'toLocaleString')" (API boundary type mismatch)

## Learnings by Category

### Mistakes (M)

#### Serde Enum Variants Default to PascalCase
Without `#[serde(rename_all = "lowercase")]`, serde deserializes enum variants using exact Rust identifier names (PascalCase). YAML value `specialist` fails to deserialize into `AgentTier::Specialist`, producing opaque "unknown variant" error.

#### Opaque Top-Level Errors Hide Serde Parse Failures
Load paths returned `None` (agent not found) rather than propagating serde parse errors, making root cause invisible. Fix required manual instrumentation of disk YAML fallback with parse error logging.

#### Incremental Instrumentation Required Multiple Investigation Rounds
Debugging session required three instrumentation passes (eisenbahn fallback, AgentStore fallback, disk YAML logging) before root cause surfaced. Comprehensive logging at each fallback layer from the start would have revealed the error in round one.

#### TypeScript Interface vs Runtime Reality
TypeScript interface declared `total_tokens: number` but Rust backend serialized `Option<u64>` as JSON `null`. TypeScript's type system doesn't enforce runtime shapes — defensive null coalescing required at API boundaries.

### Good Decisions (G)

#### Layered Fallback Investigation Was Systematic
Rather than guessing root cause, investigation methodically added logging at each layer in sequence. Systematic approach guaranteed root cause revelation regardless of which layer was responsible.

#### Targeted One-Line Fix After Root Cause Identified
Multi-hour debugging session resolved with single attribute addition (`#[serde(rename_all = "lowercase")]`). Confirms value of patience in root cause analysis vs rushing to workarounds.

### Patterns (P)

#### Bundeswehr YAML Config Enum Fields Require Explicit Serde Attributes
Codebase pattern for YAML configs uses lowercase string values in user-facing files. All enums in config layer must carry `#[serde(rename_all = "lowercase")]` — now a checklist item for new enum variants.

#### YAML Fallback Chain Pattern in Session/Agent Endpoints
Session endpoints follow fallback chain: check AgentStore (in-memory) first, then attempt disk YAML parse, then return error. Canonical lookup pattern for agent data.

### Debugging (D)

#### Progressive Logging Injection Technique
When high-level error gives no diagnostic value, technique of adding logging at each successive fallback layer and rerunning is highly effective. Each round narrows search space by one layer until raw error captured.

#### Serde "unknown variant" Error Is Definitive Root Cause Signal
Error string `unknown variant 'X', expected one of [...]` uniquely identifies missing rename attribute or schema mismatch. Fix path always: check `#[serde(rename_all)]` or `#[serde(rename)]` on target enum.

### Architecture (A)

#### Silent None Returns in Load Paths Are an Antipattern
Disk YAML fallback returned `None` on parse failure rather than typed error, collapsing two distinct states (resource missing vs parse failure) into same return value. Load paths should return `Result<Option<T>>` not `Option<T>`.

#### Structured Error Propagation Belongs at the Storage Layer
Investigation required instrumenting server endpoint layer because storage layer didn't propagate structured errors. Structured errors at storage boundary reduce future debugging cost.

## Changes Applied

### Rules Added (7 total)

#### Rust Rules (.claude/rules/rust.md)
1. Add `#[serde(rename_all = "lowercase")]` to ALL enums deserialized from user-facing YAML/JSON
2. For Bundeswehr YAML config enums, always add `#[serde(rename_all = "lowercase")]` at enum definition time
3. When serde reports `unknown variant 'X'`, immediately check for missing `#[serde(rename_all)]`
4. Log parse errors at `error!` level before returning `None` from YAML load paths
5. Agent load paths touching disk must return `Result<Option<T>>`, not `Option<T>`
6. Instrument all fallback chain layers with structured error logging at implementation time

#### Next.js Rules (.claude/rules/nextjs.md)
7. For API responses with optional numeric fields, use `?? 0` guards when performing math operations or formatting

### Knowledge Graph Entries Added (5 total)
1. **Four-Layer Agent Resolution Chain** (architecture-pattern) — eisenbahn → executor → store → disk with granular logging
2. **Layered Fallback Investigation Pattern** (debugging-technique) — systematic incremental instrumentation approach
3. **Root Cause Analysis: Patience Over Workarounds** (debugging-pattern) — value of thorough investigation vs quick fixes
4. **YAML Fallback Chain in Session/Agent Endpoints** (architecture-pattern) — canonical lookup pattern for agent data
5. **TypeScript API Boundary Defense Pattern** (coding-convention) — nullish coalescing for Rust Option fields

## Files Modified

### Code Fixes
- `crates/agent/src/types.rs` — Added `#[serde(rename_all = "lowercase")]` to `AgentTier` enum
- `crates/agent/src/config.rs` — Updated 3 test YAML strings to lowercase tier values
- `crates/agent/src/yaml_schema.rs` — Updated 2 test YAML strings to lowercase tier values
- `crates/agent/src/agent_store.rs` — Added startup logging with agent names list, debug logging on lookup miss
- `crates/server/src/api/agents/execute.rs` — Made `resolve_from_agent_store` public, added disk fallback with parse error logging
- `crates/server/src/api/agents/sessions_execute.rs` — Added AgentStore fallback for session endpoints
- `dashboard/app/bundeswehr/[name]/page.tsx` — Added null guards to `formatNumber` and stats rendering

### Documentation
- `.claude/rules/rust.md` — Added 6 new rules (YAML deserialization + error handling sections)
- `.claude/rules/nextjs.md` — Added 1 new rule (API boundary safety section)

## Metrics
- **Investigation Time**: ~2 hours across both sessions
- **Root Cause Rounds**: 3 rounds (eisenbahn, AgentStore, disk YAML)
- **Fix Size**: 1 line (serde attribute) + 1 function signature (null guard)
- **Test Impact**: 60 tests (all passing after YAML updates)
- **Rules Added**: 7 (6 Rust, 1 Next.js)
- **KG Entries**: 5 (2 architecture, 2 debugging, 1 convention)

## Notes
Both errors share a common theme: **type systems don't enforce runtime correctness**. Serde defaults to PascalCase but YAML uses lowercase. TypeScript declares `number` but Rust sends `null`. The fix in both cases is defensive programming at boundaries: explicit serde attributes and nullish coalescing. Future work should proactively apply these patterns rather than discovering them through debugging.
