# Retrospective: 2026-02-16 06:44

## Session Focus
Debug and optimize Rust/Cargo build and test performance on Windows. Diagnosed sccache configuration issues and applied comprehensive performance optimizations.

## Learnings by Category

### Mistakes (M)
- **sccache TOML section error**: Placed `RUSTC_WRAPPER` in `[env]` instead of using `rustc-wrapper` in `[build]` section. This caused sccache to be silently ignored despite appearing in cargo build -vv output.
  - Root cause: Misunderstanding of Cargo config section semantics
  - Impact: Lost 70% clean build speedup for entire session until fixed
  - Prevention: Verify tool activation with stats/verbose output immediately after config changes

### Good Decisions (G)
- **Baseline measurement before optimization**: Measured 3min builds, 14s tests before changes. This allowed quantifying each improvement.
  - Impact: Proved 70% build speedup, 90% test speedup with concrete numbers
  - Reusable: Always measure baseline before performance work

- **cargo-nextest for workspace testing**: Adopted nextest instead of cargo test for true parallel execution across all 16 cores.
  - Impact: 14s → 1.4s (90% faster) for 538 tests
  - Reusable: Workspace projects with many small tests benefit most

- **Incremental optimization with measurement points**: Applied optimizations one-by-one (profiles → sccache → nextest → lld) with measurements between.
  - Impact: Could isolate which changes contributed to improvement
  - Reusable: Layered performance debugging practice

### Patterns (P)
- **Cargo TOML [build] vs [env] debugging**: When Cargo env vars don't work, check section placement in .cargo/config.toml.
  - Build configuration (rustc-wrapper, linker) goes in `[build]`
  - Environment variables (SCCACHE_DIR, custom vars) go in `[env]`
  - Windows-specific: Path escaping required in [env] section

- **sccache validation pattern**: Use `sccache --show-stats` immediately after configuration.
  - 0 compile requests = wrapper not invoked
  - 0 cache hits on second clean build = misconfiguration
  - Expected: ~95% hit rate on repeated clean builds

### Debugging (D)
- **Config section semantic debugging**: Cargo silently ignored RUSTC_WRAPPER in [env] because it expects `rustc-wrapper` (hyphenated) in [build].
  - Technique: Use `cargo build -vv` to see actual rustc invocation
  - Look for `RUSTC_WRAPPER=sccache` in environment vs `rustc-wrapper` config

- **Tool validation workflow**: After config changes, always verify tool is active:
  1. Make config change
  2. Run verbose build (`cargo build -vv`)
  3. Check tool stats/logs (`sccache --show-stats`)
  4. Measure performance delta

### Architecture (A)
- **Early build optimization investment**: 3min builds would compound over development lifetime. Investing time upfront to optimize build/test cycle pays back within days on 12-crate workspace.
  - ROI: ~3 hours debugging → 2.5min saved per build → breakeven at ~72 builds (~1 day of development)

## Changes Applied

### Rules Added
1. **rust.md**: Place `rustc-wrapper` in `[build]` section of `.cargo/config.toml` -- never in `[env]`
2. **rust.md**: After changing `.cargo/config.toml` or build profiles, verify with `cargo build -vv` to confirm tools are active
3. **rust.md**: Expect sccache 0 hits with `incremental = true` -- sccache caches clean builds, not incremental ones

### Knowledge Graph Entries Added
1. **cargo-rustc-wrapper-configuration** (pattern): Rustc-wrapper section placement and Windows path escaping
2. **sccache-incremental-build-diagnostics** (pattern): Diagnostic techniques for sccache troubleshooting
3. **rust-build-optimization-stack** (decision): Combined sccache + nextest + profiles + lld with rationale
4. **windows-cargo-configuration-differences** (convention): Platform-specific Cargo config requirements
5. **rust-test-profile-optimization-tradeoffs** (decision): Test profile opt-level balancing with rationale

### Memory.md Updated
Added "Rust Build Optimization Patterns" section documenting:
- Cargo configuration section semantics
- sccache diagnostics workflow
- Performance stack combination
- Test profile tuning guidelines

## Performance Results

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| Clean build (first) | ~3min | ~2m 25s | 17% faster |
| Clean build (cached) | ~3min | ~44s | 70% faster |
| Test execution | ~14s | ~1.4s | 90% faster |
| Incremental (no change) | 0.36s | 0.36s | Same |

**sccache statistics**: 94.71% cache hit rate (340/359 compilations)

## Notes

This session demonstrated the value of:
1. Systematic debugging with verbose output inspection
2. Measuring baselines before optimization
3. Tool validation immediately after configuration
4. Documenting platform-specific gotchas for future reference

The sccache configuration issue was subtle but had massive impact. The fix (moving rustc-wrapper from [env] to [build]) was one line, but finding it required careful analysis of cargo -vv output.
